From 38b57f43b7cc550cadde547dd350de7dccb4096f Mon Sep 17 00:00:00 2001
From: Peter Collingbourne <collingbourne2@llnl.gov>
Date: Thu, 3 Dec 2009 00:50:08 -0800
Subject: [PATCH] If this is a matrix build use the parent's commit to ensure consistent behaviour across all children.

---
 src/main/java/hudson/plugins/git/GitSCM.java |   19 +++++++++++++++++++
 1 files changed, 19 insertions(+), 0 deletions(-)

diff --git a/src/main/java/hudson/plugins/git/GitSCM.java b/src/main/java/hudson/plugins/git/GitSCM.java
index 7c48180..35510bb 100644
--- a/src/main/java/hudson/plugins/git/GitSCM.java
+++ b/src/main/java/hudson/plugins/git/GitSCM.java
@@ -6,6 +6,8 @@ import hudson.FilePath;
 import hudson.Launcher;
 import hudson.Proc;
 import hudson.FilePath.FileCallable;
+import hudson.matrix.MatrixBuild;
+import hudson.matrix.MatrixRun;
 import hudson.model.AbstractBuild;
 import hudson.model.AbstractProject;
 import hudson.model.Action;
@@ -423,6 +425,20 @@ public class GitSCM extends SCM implements Serializable {
         final EnvVars environment = tmp;
 
         final String singleBranch = getSingleBranch(build);
+		
+		Revision tempParentLastBuiltRev = null;
+
+		if (build instanceof MatrixRun) {
+			MatrixBuild parentBuild = ((MatrixRun)build).getParentBuild();
+			if (parentBuild != null) {
+				BuildData parentBuildData = parentBuild.getAction(BuildData.class);
+				if (parentBuildData != null) {
+					tempParentLastBuiltRev = parentBuildData.getLastBuiltRevision();
+				}
+			}
+		}
+
+		final Revision parentLastBuiltRev = tempParentLastBuiltRev;
 
 		final Revision revToBuild = workspace.act(new FileCallable<Revision>() {
 			private static final long serialVersionUID = 1L;
@@ -486,6 +502,9 @@ public class GitSCM extends SCM implements Serializable {
 					}
 				}
 
+				if (parentLastBuiltRev != null)
+					return parentLastBuiltRev;
+
                 IBuildChooser buildChooser = new BuildChooser(GitSCM.this,git,new GitUtils(listener,git), buildData );
 
                 Collection<Revision> candidates = buildChooser.getCandidateRevisions(false, singleBranch);
-- 
1.6.3.3

